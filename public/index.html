<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>React Tutorial</title>
    <!-- Not present in the tutorial. Just for basic styling. -->
    <link rel="stylesheet" href="css/base.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.6/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.6/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.0.5/redux.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-redux/4.0.6/react-redux.js"></script>
    <script src="scripts/redux-thunk.js"></script>

  </head>
  <body>
    <div id="content"></div>
    <!-- <script type="text/babel" src="scripts/final.js"></script> -->
    <script type="text/babel">
    let comments = [
        {id: 1, author: "Cory Brown", text: "My 2 scents"},
        {id: 2, author: "Jared Anderson", text: "Let me put it this way. You've heard of Socrates? Aristotle? Plato? Morons!"},
        {id: 3, author: "Matt Poulson", text: "It's just a function!"},
        {id: 4, author: "Bruce Campbell", text: "Fish in a tree? How can that be?"}
    ];

    const Comment = (props) => (
       <div className="comment">
           <h2 className="commentAuthor">
               { props.author }
           </h2>
           { props.children }
       </div>
     );

    const CommentList = function (props, context) {
        return (
        <div className="commentList">
            { props.comments.map(comment => (
                <Comment author={ comment.author } key={comment.id} >
                    { comment.text }
                </Comment>
            )) }
        </div>
    );};

    const CommentForm = (props) => (
        <form className="commentForm"
              onSubmit={ (e) => {
                  e.preventDefault();
                  props.onCommentSubmit();
              }}
        >
            <input type="text"
                   name="author"
                   placeholder="Your name"
                   value={ props.author }
                   onChange={ (e) =>
                       props.onAuthorChange(e.target.value) }

    />
            <input type="text"
                   name="text"
                   placeholder="Say something..."
                   value={ props.text }
                   onChange={ (e) =>
                       props.onTextChange(e.target.value) }
            />
            <button>Post</button>
        </form>
    );

    const { createClass, PropTypes } = React;
    const CommentBox = createClass({
        contextTypes: {
            store: PropTypes.object
        },
        componentDidMount() {
            const { store } = this.context;
            this.unsubscribe = store.subscribe( () => this.forceUpdate() )
        },
        componentWillUnmount() {
            this.unsubscribe();
        },
        render() {
            const { store } = this.context;
            const { getState } = store;
            const { items, author, text } = getState();
            console.log(author, text);
            return (
                <div className="commentBox">
                    <h1>Comments</h1>
                    <CommentList comments={ items } />
                    <CommentForm
                        author={ author }
                        text={ text }

                        onCommentSubmit={ () =>
                            dispatch(addComment({author, text})) }

                        onAuthorChange={ (author) =>
                            dispatch(authorChange(author)) }

                        onTextChange={ (text) =>
                            dispatch(textChange(text)) }
                    />
                </div>
            );
        }
    });

    const actions = {
        ADD_COMMENT:    Symbol('ADD_COMMENT'),
        AUTHOR_CHANGE:  Symbol('AUTHOR_CHANGE'),
        TEXT_CHANGE:    Symbol('TEXT_CHANGE')
    };

    const addComment = (comment) => ({
        foo: console.log('adding Comment', comment),
        type: actions.ADD_COMMENT,
        comment
    });

    const authorChange = (author) => ({
        type: actions.AUTHOR_CHANGE,
        author
    });

    const textChange = (text) => ({
        type: actions.TEXT_CHANGE,
        text
    });

    const commentsReducer = (state={
        items:[],
        author:'',
        text: ''
    }, action) => {
        console.log('action type: ', action.type);
        switch (action.type) {
            case actions.ADD_COMMENT:
            return {
                ...state,
                items: [...state.items, {id: Math.random(), ...action.comment}]
            };

            case actions.AUTHOR_CHANGE:
            return {
                ...state,
                author: action.author
            };

            case actions.TEXT_CHANGE:
            return {
                ...state,
                text: action.text
            };

            default:
            return state;

        }
    };

    const { createStore } = Redux;
    const store = createStore(commentsReducer);
    const { getState, dispatch } = store;
    comments.map(comment => dispatch( addComment(comment) ));
    console.log(getState());


    const { Provider } = ReactRedux;
    ReactDOM.render(
        <Provider store={ store }>
            <CommentBox />
        </Provider>,
        // <div className="commmentBox">
        //     <CommentList comments={ comments } />
        //     <CommentForm />
        // </div>,
        document.querySelector('#content')
    );


    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.4.4/babel.min.js"></script>
    <script src="scripts/babeler.js"></script>
  </body>
</html>
